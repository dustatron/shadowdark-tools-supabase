# Implementation Plan: User-Generated Magic Items

**Branch**: `012-for-magic-items` | **Date**: 2025-12-05 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-for-magic-items/spec.md`

## Summary

Enable users to create custom magic items with public/private visibility. Display source attribution showing "Core Rules" for official items and creator username for community items. Follows established patterns from user_monsters and user_spells.

## Technical Context

**Language/Version**: TypeScript 5, Next.js 15
**Primary Dependencies**: React 19, shadcn/ui, react-hook-form, Zod
**Storage**: Supabase PostgreSQL with RLS
**Testing**: Vitest (unit), Playwright (E2E)
**Target Platform**: Web (Vercel)
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: <2s page load, <500ms search
**Constraints**: Mobile responsive, follows Shadowdark rules
**Scale/Scope**: Existing user base, ~100 official magic items

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle               | Status  | Notes                                                |
| ----------------------- | ------- | ---------------------------------------------------- |
| I. Component-First      | ✅ PASS | Magic item form, card, detail as reusable components |
| II. API-First           | ✅ PASS | REST endpoints with Zod validation                   |
| III. Test-First         | ✅ PASS | Contract tests, integration tests planned            |
| IV. Integration Testing | ✅ PASS | Auth flow, CRUD operations covered                   |
| V. Simplicity           | ✅ PASS | Follows existing user_monsters pattern               |
| VI. Data Integrity      | ✅ PASS | Zod schemas, DB constraints                          |
| VII. Community Safety   | ✅ PASS | Default private, public opt-in                       |

## Project Structure

### Documentation (this feature)

```
specs/012-for-magic-items/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research
├── data-model.md        # Database schema
├── quickstart.md        # User flows
├── contracts/           # API contracts
│   └── api-contracts.md
└── tasks.md             # (Generated by /tasks)
```

### Source Code (repository root)

```
# Web application structure
app/
├── api/user/magic-items/         # API routes (new)
│   ├── route.ts                  # GET list, POST create
│   └── [id]/route.ts             # GET, PUT, DELETE
├── magic-items/
│   ├── create/page.tsx           # Create form (new)
│   ├── [slug]/edit/page.tsx      # Edit form (new)
│   └── my-items/page.tsx         # User's items (new)

components/
├── magic-items/
│   ├── MagicItemForm.tsx         # Create/edit form (new)
│   ├── MagicItemCard.tsx         # Update for source
│   └── SourceBadge.tsx           # Attribution badge (new)

lib/
├── schemas/magic-items.ts        # Zod schemas (new)

supabase/migrations/
├── YYYYMMDD_create_user_magic_items.sql
└── YYYYMMDD_create_all_magic_items_view.sql
```

**Structure Decision**: Web application (Option 2) - Next.js App Router

## Phase 0: Outline & Research

**Status**: ✅ Complete

See [research.md](./research.md) for:

- Existing patterns from user_monsters, user_spells
- Decisions on duplicate names, visibility defaults, account deletion
- Technical approach for schema, views, API

## Phase 1: Design & Contracts

**Status**: ✅ Complete

**Artifacts**:

- [data-model.md](./data-model.md) - Database schema, indexes, RLS
- [contracts/api-contracts.md](./contracts/api-contracts.md) - REST endpoints, Zod schemas
- [quickstart.md](./quickstart.md) - User flows, validation scenarios

## Phase 2: Task Planning Approach

**Status**: ✅ Ready for /tasks

**Task Generation Strategy**:

- Database migration tasks (schema, view, RLS policies)
- API route handler tasks (CRUD endpoints)
- Component tasks (form, card updates, source badge)
- Page tasks (create, edit, my-items)
- Integration tasks (update search endpoint)

**Ordering Strategy**:

1. Database first (migration)
2. Zod schemas (shared validation)
3. API routes (backend)
4. Components (UI building blocks)
5. Pages (compose components)
6. Integration (update existing search)
7. Tests throughout (TDD)

**Estimated Output**: ~20-25 tasks

## Complexity Tracking

No constitution violations. Follows established patterns.

## Progress Tracking

**Phase Status**:

- [x] Phase 0: Research complete
- [x] Phase 1: Design complete
- [x] Phase 2: Task planning complete (approach described)
- [x] Phase 3: Tasks generated (/tasks command) - 32 tasks
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:

- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented (none)

---

_Based on Constitution v1.4.0 - See `.specify/memory/constitution.md`_
